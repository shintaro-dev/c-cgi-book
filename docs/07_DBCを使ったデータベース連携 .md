# 7. ODBCを使ったデータベース連携

## 7.1 データベースとCGI

これまでの章では、フォームから受け取ったデータをCGIプログラム内部で処理してきました。  
しかし、実際のWebアプリケーションでは、**データをファイルに保存するだけでは不十分**なことが多くなります。

たとえば…

- ユーザー登録情報を管理したい
- 投稿されたメッセージを一覧表示したい
- 商品一覧をカテゴリごとに絞り込みたい

こういったケースでは、  
**「たくさんのデータを安全に、素早く、柔軟に扱える仕組み」**が必要になります。

これを支えるのが、**データベース（Database）** です。

---

### データベースとは？

データベースとは、  
**大量のデータを効率的に保存・検索・更新できる仕組み**を指します。

特に、Webアプリケーションでよく使われるデータベースには、

- MySQL / MariaDB
- PostgreSQL
- SQLite
- Oracle Database

などがあります。

これらのデータベースとアプリケーションの間をつなぐことで、  
ユーザーがアクセスするたびに「最新のデータ」をリアルタイムにやりとりできるようになります。

---

### なぜCGIとデータベースを連携するのか？

CGIプログラム単体では、**受け取ったデータを一時的に処理する**ことはできます。  
しかし、データベースを使うと、

- データを永続的に保存できる
- 大量のデータから必要なものだけを効率的に取り出せる
- 同時に複数のユーザーが利用できる

といった**本格的なWebアプリケーションに必要な機能**が実現できるようになります。

CGIとデータベースの連携は、  
単なる「問い合わせフォーム」を超えて、**本格的な「Webサービス」へとステップアップするための重要な技術**なのです。

---

### C言語からデータベースにアクセスするには？

世の中には、PHPやPythonのような**データベースアクセス用ライブラリが標準で豊富な言語**もあります。  
しかし、C言語では**直接データベースと通信する機能は標準装備されていません**。

そこで登場するのが、**ODBC（Open Database Connectivity）**という共通仕様です。

ODBCを使うことで、  
**「データベース製品ごとの違いを吸収しながら」**  
**「C言語から共通の手順でデータベースに接続・操作」**できるようになります。

また、C言語には他にも、データベースにアクセスする手段として  
**埋め込みSQL方式**（例えばOracleの**Pro\*C**やInformixの**ESQL/C**など）も存在します。

埋め込みSQL方式では、Cソースコード中に直接SQL文を記述し、  
専用のプリコンパイラによってCソース＋SQLを通常のC言語ソースに変換します。  
この方法は高いパフォーマンスが期待できる一方で、  
**データベース製品に強く依存しやすく、移植性に難がある**というデメリットもあります。

本書では、**製品依存をできるだけ避け、標準的な方法で幅広く対応できる**よう、  
ODBCを採用して進めていきます。

---

### 本章のゴール

この章では、  
C言語のCGIプログラムから**ODBCを使ってデータベースに接続し、データの読み書きを行う**方法を学びます。

また、  
「フォームから受け取ったデータをデータベースに保存する」  
「データベースの内容をHTML形式で一覧表示する」  
といった実践的な処理も体験していきます。

> ※ 本章のサンプルを実行するには、ODBCドライバと接続設定（DSN登録不要）が必要です。  
> （詳しくはAppendix「環境構築ガイド」を参照してください）

それでは、まずはODBCの仕組みから見ていきましょう！

---

## 7.2 ODBCの仕組み

### 7.2.1 ODBCとは何か？

ODBCとは、**Open Database Connectivity（オープン・データベース・コネクティビティ）**の略です。  
その名前の通り、**異なる種類のデータベースに「共通の方法」でアクセスできるようにするための仕組み**です。

たとえば、  
本来ならMySQLとPostgreSQLでは、データベースへの接続手順やコマンドが異なります。  
しかし、ODBCを使うと、アプリケーション側は**共通の関数と命令**だけを使えばよくなります。

> **イメージ図：**  
> - アプリケーション（C言語CGI） → 【ODBC】 → データベース（MySQL, PostgreSQL, など）

つまり、  
**「データベース製品ごとの違いを吸収する中間レイヤー」**  
それがODBCの役割です。

---

### なぜODBCを使うのか？

C言語で直接データベースと通信しようとすると、  
各DB製品専用のライブラリを使わなければなりません。

- MySQL専用のライブラリ（libmysqlclient）
- PostgreSQL専用のライブラリ（libpq）

また、別の方法として  
**埋め込みSQL方式（Pro\*C、ESQL/Cなど）**も存在します。  
この方式では、Cソースコード中に直接SQLを記述し、プリコンパイルしてCコードに変換する手法です。  
ただし、**特定のデータベース製品に依存しやすい**ため、移植性や将来性を考えると課題もあります。

ODBCを使えば、  
アプリケーション側は「ODBC標準仕様」にだけ従えばよいため、  
**将来、データベースを変更する場合も最小限の影響で済む**のです。

---

> ✅ まとめ
> 
> - ODBCは「異なるデータベースに共通手順でアクセスできる仕組み」
> - アプリケーションの移植性と柔軟性を高める
> - C言語からデータベースを扱うときの強力な武器になる

---

次は、  
**「ODBCって具体的にどんな部品でできてるの？」**  
を見ていきましょう！

---

### 7.2.2 ODBCの構成要素

ODBCは、ただ一つの部品でできているわけではありません。  
実際には、次の**三つの要素**が連携して動いています。

---

#### アプリケーション（今回のCGIプログラム）

アプリケーションは、ユーザーのリクエストに応じてデータベースにアクセスする側です。  
私たちがこれから書く**C言語のCGIプログラム**が、まさにこの役割を担います。

アプリケーションは、データベースに直接話しかけるのではなく、  
**ODBCのAPI**（`SQLDriverConnect`や`SQLExecDirect`など）を通して接続・操作を行います。

---

#### ドライバマネージャ

ドライバマネージャは、  
**アプリケーションとドライバの間を仲介する役割**を持っています。

たとえばLinux環境では、`unixODBC`というドライバマネージャがよく使われます。  
Windows環境では、OSに標準で組み込まれています。

ドライバマネージャの役割は：

- アプリケーションからのリクエストを受け取る
- 適切なドライバを選び出して呼び出す
- 必要に応じてエラーメッセージや情報を中継する

といった**交通整理役**です。

アプリケーション側は、**「どのデータベースなのか」**をあまり意識せず、  
共通の手順だけで命令を出せるようになります。

---

#### ドライバ

ドライバは、  
**実際にデータベースと通信を行う本体**です。

たとえばMariaDB用のドライバなら、  
MariaDB特有のプロトコルに従って接続したり、SQLを送ったり、結果を受け取ったりします。

ポイントは、  
**各データベース製品ごとに専用ドライバが存在する**  
ということです。

- MariaDB用 ODBCドライバ
- PostgreSQL用 ODBCドライバ
- SQLite用 ODBCドライバ
などなど。

ドライバを切り替えれば、アプリケーションのコードを大きく変えずに、  
別のデータベースに対応することも可能になります。

> ※ ただし、SQL文の細かい文法（SQL方言）には差異があるため、移植時には注意が必要です。

---

#### 三者の関係図

ここで簡単な流れをまとめておきましょう。

```plaintext
[アプリケーション（CGI）]
          ↓ (SQL発行)
[ドライバマネージャ]
          ↓ (ドライバ選択・中継)
[ドライバ]
          ↓ (DB接続・データ操作)
[データベース（MariaDBなど）]
```

このように、アプリケーションから見れば、  
**ドライバマネージャが適切なドライバを呼び出し、ドライバがDBと直接通信する**  
という二段構えの構成になっています。

---

#### まとめ

- **アプリケーション**はODBC APIを使ってリクエストを出す
- **ドライバマネージャ**はリクエストを中継し、ドライバを管理する
- **ドライバ**は実際にデータベースとやりとりを行う

この構成によって、  
私たちは**データベース製品の違いに振り回されず**に、  
**共通の手順でデータ操作ができる**わけです。
