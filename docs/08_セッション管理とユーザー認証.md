## 8. セッション管理とユーザー認証

### 8.1 セッション管理の基礎

これまでの章では、フォーム入力やデータベース連携といった、  
「リクエスト単位で完結する処理」を学んできました。

しかし、実際のWebアプリケーションでは、  
**「同じユーザーが連続してアクセスしている」**  
ことを識別できる仕組みが必要になります。

たとえば：

- ログイン後のマイページ表示
- カートに商品を追加していく処理
- 購入手続き中にページ遷移しても情報を保持する

これらは、**単なるリクエストだけでは管理できません。**

そこで登場するのが、  
**「セッション（Session）」**という仕組みです。

---

### セッションとは？

セッションとは、  
**「同じユーザーが連続してアクセスしていることを覚えておく仕組み」**です。

Webは本来「ステートレス（無状態）」な仕組みなので、  
普通にページを行き来するだけでは、サーバ側は  
「誰がアクセスしているのか？」を判断できません。

そこで：

- ユーザーに**一意な識別子（セッションID）**を割り当てる
- サーバ側で**セッションIDと紐づけてデータを保存**する
- 次のリクエストでも**セッションIDを確認**することで、同一ユーザーを判別する

という流れで、  
**「ログインしている状態」**や  
**「カートに商品が入っている状態」**を管理できるわけです。

---

### セッションIDの受け渡し方法

セッションIDをユーザーとサーバ間でやりとりするには、  
いくつか方法がありますが、基本的には

- **Cookie（クッキー）**にセッションIDを保存する

というやり方が一般的です。

Cookieとは、  
**ブラウザに小さなデータ（セッションIDなど）を保存しておく仕組み**で、  
次のリクエスト時に自動的にサーバに送られます。

つまり、サーバ側は、

- 初回アクセス時にセッションIDを発行
- Cookieとしてブラウザに渡す
- 次回以降のリクエストで、Cookie経由でセッションIDを受け取る

ことで、  
**ユーザーの連続した操作を認識できる**わけです。

---

### なぜセッション管理が重要なのか？

- **ログイン認証を維持するため**  
（ユーザーが毎回ID/PW入力しなくても済む）

- **一時的な作業状態を保存するため**  
（カート、入力途中データなど）

- **安全なアクセス制御を実現するため**  
（未ログインユーザーが管理画面に入れないようにする）

Webアプリケーションにとって、  
**セッション管理はほぼ必須の技術**です！

---

### この章で目指すこと

この章では、

- **C言語＋CGIでセッション管理を実装する**
- **ファイルベースでシンプルなセッション管理システムを作る**
- **ログイン機能とログアウト機能を実装する**

ことを目標に進めていきます。

---

それでは次に、  
**実際にセッションIDを発行して管理する方法**を見ていきましょう！

### 8.2 セッションID発行と管理

セッション管理の基本を押さえたところで、  
次は**実際にセッションIDを発行して管理する仕組み**を作っていきましょう！

---

### セッションIDの役割

セッションIDは、  
**「このリクエストは○○さんのものだ」**  
とサーバが識別するための**目印**です。

ポイントは：

- **ランダムで一意なIDを発行すること**
- **推測されにくい長さ・複雑さを持つこと**
- **サーバ側でこのIDに紐づくデータを管理すること**

です。

---

### セッションIDの発行方法

今回はシンプルな方法として、

- ランダムな英数字を組み合わせた文字列を作る
- これをセッションIDとして使う

というアプローチを取ります。

※ 実際には暗号的に安全なランダム生成（例：OpenSSL）を使うべきですが、  
ここでは教材として**シンプルな例**にとどめます。

#### サンプル：簡単なセッションID生成関数（C言語）

```c
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

void generate_session_id(char *buffer, size_t length) {
    const char charset[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    size_t charset_size = sizeof(charset) - 1;

    srand((unsigned int)time(NULL));

    for (size_t i = 0; i < length - 1; i++) {
        int key = rand() % charset_size;
        buffer[i] = charset[key];
    }
    buffer[length - 1] = '\0';
}
```

使い方例：

```c
char session_id[33];  // 32文字 + NULL終端
generate_session_id(session_id, sizeof(session_id));
printf("生成されたセッションID: %s\n", session_id);
```

---

### セッション情報の保存場所

セッションIDを発行したら、  
サーバ側で**そのIDに紐づく情報を保存**する必要があります。

今回はシンプルに、

- サーバ上に**「セッションファイル」**を作成
- ファイル名にセッションIDを使う
- ファイルの中に、ログインユーザー名などを保存する

という構成を取ります。

たとえば：

```
/tmp/session/abc123xyz456.def789ghi012
（中身：user_id=1、username="taro" など）
```

---

### セッションIDをクライアントに渡す

発行したセッションIDは、  
**HTTPレスポンスヘッダでCookieとしてクライアントに渡す**  
必要があります。

サンプル（CGIの出力）：

```c
printf("Set-Cookie: SESSION_ID=%s; Path=/; HttpOnly\n", session_id);
```

こうすることで、ブラウザは自動的にSESSION_IDを保存し、  
次回以降のリクエスト時にサーバに送信してくれるようになります。

---

### まとめ

- セッションIDはランダムで一意なものを発行する
- サーバ上でセッションIDに対応するデータを保存する
- クライアントにはCookieでセッションIDを渡す

---

次は、  
**「セッションを使ってログイン状態を管理する」**  
実践編に進みましょう！

### 8.3 ログイン処理

ここからは、  
**実際にログインフォームを使って認証し、セッションを開始する**  
仕組みを作っていきます！

---

### ログイン処理の流れ

ログイン機能の基本的な流れはこうです：

1. ユーザーがログインフォームにIDとパスワードを入力
2. サーバが受け取ったID/PWを検証
3. 正しければセッションを発行し、ログイン状態を作成
4. 間違っていればエラーメッセージを表示

---

### サンプル：ログインフォーム（HTML）

```html
<form action="/cgi-bin/login.cgi" method="post">
    <label for="username">ユーザー名:</label><br>
    <input type="text" id="username" name="username"><br>
    <label for="password">パスワード:</label><br>
    <input type="password" id="password" name="password"><br><br>
    <input type="submit" value="ログイン">
</form>
```

- `POST`メソッドで`login.cgi`に送信
- ユーザー名とパスワードを渡す

---

### サンプル：ログイン処理（C言語・CGI）

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "cgi_utils.h"  // フォームデータ受信用ヘッダ（別途作成想定）

int main(void)
{
    char *username = NULL;
    char *password = NULL;
    char session_id[33];

    printf("Content-Type: text/html\n");

    // フォームデータ受信
    cgi_parse_post_data();
    username = cgi_get_value("username");
    password = cgi_get_value("password");

    if (username && password) {
        // 仮の認証ロジック（実際にはDB確認などすべき）
        if (strcmp(username, "admin") == 0 && strcmp(password, "password") == 0) {
            generate_session_id(session_id, sizeof(session_id));
            save_session_data(session_id, username);

            printf("Set-Cookie: SESSION_ID=%s; Path=/; HttpOnly\n", session_id);
            printf("\n");
            printf("<html><body>\n");
            printf("<h1>ログイン成功！</h1>\n");
            printf("<a href=\"/cgi-bin/protected.cgi\">マイページへ</a>\n");
            printf("</body></html>\n");
        } else {
            printf("\n");
            printf("<html><body>\n");
            printf("<h1>ログイン失敗</h1>\n");
            printf("<p>ユーザー名またはパスワードが違います。</p>\n");
            printf("<a href=\"/login.html\">戻る</a>\n");
            printf("</body></html>\n");
        }
    } else {
        printf("\n");
        printf("<html><body>\n");
        printf("<h1>エラー</h1>\n");
        printf("<p>フォームデータが正しく受信できませんでした。</p>\n");
        printf("</body></html>\n");
    }

    return 0;
}
```

---

### 注意点

- 本サンプルでは**認証ロジックをハードコーディング**していますが、  
  実際には**データベースに保存されたユーザー情報と照合**するべきです。
- **パスワードは本来ハッシュ化して保存・比較**すべきです。

ここでは流れをシンプルに理解するため、最低限の構成にとどめています。

---

### まとめ

- フォームからユーザー名とパスワードを受信
- 照合に成功したらセッションIDを発行し、Cookieにセット
- 失敗したらエラーメッセージ表示

---

次は、  
**「発行したセッションIDを使ってアクセス制御を行う」**  
ステップに進みましょう！
